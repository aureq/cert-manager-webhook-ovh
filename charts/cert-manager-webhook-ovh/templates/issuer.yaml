{{- range $.Values.issuers }}
  {{- if .create }}
    {{- if or (and (.ovhAuthentication) (.ovhAuthenticationRef)) (and (not .ovhAuthentication) (not .ovhAuthenticationRef)) }}
      {{ fail "Error: For each issuer you wish to create, you need to define either 'ovhAuthentication' or 'ovhAuthenticationRef'" }}
    {{- end }}
apiVersion: cert-manager.io/v1
kind: {{ .kind }}
metadata:
  labels:
    {{- include "cert-manager-webhook-ovh.labels" $ | nindent 4 }}
  name: {{ .name | quote }}
  {{- if eq .kind "Issuer" }}
  namespace: {{ .namespace | quote }}
  {{- end }}
spec:
  acme:
    server: {{ .acmeServerUrl | default "https://acme-v02.api.letsencrypt.org/directory" | quote }}
    {{- if .email }}
    email: {{ .email | quote }}
    {{- end}}
    privateKeySecretRef:
      name: {{ printf "%s-account-key" .name | quote }}
    solvers:
    - dns01:
        cnameStrategy: {{ .cnameStrategy | default "None" | quote }}
        webhook:
          solverName: ovh
          groupName: {{ $.Values.groupName | quote }}
          config:
            endpoint: {{ .ovhEndpointName | quote }}
            {{- if eq (include "cert-manager-webhook-ovh.isOvhAuthenticationAvail" .ovhAuthentication) "true" }}
            authenticationMethod: {{ .ovhAuthentication.authenticationMethod }}
            {{- if eq "application" .ovhAuthentication.authenticationMethod }}
            applicationKeyRef:
              name: {{ printf "%s-ovh-credentials" .name }}
              key: "applicationKey"
            applicationSecretRef:
              name: {{ printf "%s-ovh-credentials" .name }}
              key: "applicationSecret"
            applicationConsumerKeyRef:
              name: {{ printf "%s-ovh-credentials" .name }}
              key: "applicationConsumerKey"
            {{- else if eq "oauth2" .ovhAuthentication.authenticationMethod }}
            oauth2ClientIdRef:
              name: {{ printf "%s-ovh-credentials" .name }}
              key: "oauth2ClientId"
            oauth2ClientSecretRef:
              name: {{ printf "%s-ovh-credentials" .name }}
              key: "oauth2ClientSecret"
            {{- end }}
            {{- end }}

            {{- if eq (include "cert-manager-webhook-ovh.isOvhAuthenticationRefAvail" .ovhAuthenticationRef) "true" }}
            authenticationMethod: {{ .ovhAuthenticationRef.authenticationMethod }}
            {{- if eq "application" .ovhAuthenticationRef.authenticationMethod }}
            applicationKeyRef:
              name: {{ .ovhAuthenticationRef.applicationKeyRef.name }}
              key: {{ .ovhAuthenticationRef.applicationKeyRef.key }}
            applicationSecretRef:
              name: {{ .ovhAuthenticationRef.applicationSecretRef.name }}
              key: {{ .ovhAuthenticationRef.applicationSecretRef.key }}
            applicationConsumerKeyRef:
              name: {{ .ovhAuthenticationRef.applicationConsumerKeyRef.name }}
              key: {{ .ovhAuthenticationRef.applicationConsumerKeyRef.key }}
            {{- else if eq "oauth2" .ovhAuthenticationRef.authenticationMethod }}
            oauth2ClientIdRef:
              name: {{ .ovhAuthenticationRef.oauth2ClientIdRef.name }}
              key: {{ .ovhAuthenticationRef.oauth2ClientIdRef.key }}
            oauth2ClientSecretRef:
              name: {{ .ovhAuthenticationRef.oauth2ClientSecretRef.name }}
              key: {{ .ovhAuthenticationRef.oauth2ClientSecretRef.key }}
            {{- end }}
            {{- end }}            
---
  {{- end }}{{/* end if .create */}}
{{- end }}{{/* end range */}}
