---
suite: Testing `root.issuers` option in `issuer.yaml` 1/2
templates:
  - issuer.yaml
values:
  - values/valid/values.yaml
chart:
  version: 1.0.0
  appVersion: 1.0.0
tests:
  - it: Validate use of `issuers` option in `ClusterIssuer` 1/5
    documentSelector:
      path: kind
      value: ClusterIssuer
      matchMany: true
    asserts:
      - hasDocuments:
          count: 5
          filterAware: true

  - it: Validate use of `issuers` option in `ClusterIssuer` 2/5
    documentSelector:
      path: $[?(@.kind == "ClusterIssuer")].metadata.name
      value: letsencrypt-prod
    asserts:
      - equal:
          path: kind
          value: ClusterIssuer
      - equal:
          path: metadata.name
          value: letsencrypt-prod
      - equal:
          path: metadata.namespace
          value: default
        not: true
      - equal:
          path: spec.acme.server
          value: https://acme-v02.api.letsencrypt.org/directory
      - equal:
          path: spec.acme.email
          value: tls-manager@example.net
      - notExists:
          path: spec.acme.disableAccountKeyGeneration
      - notExists:
          path: spec.acme.externalAccountBinding
      - equal:
          path: spec.acme.profile
          value: classic
      - lengthEqual:
          path: spec.acme.solvers
          count: 1
      - equal:
          path: spec.acme.solvers[0].dns01.cnameStrategy
          value: None
      - equal:
          path: spec.acme.solvers[0].dns01.webhook.solverName
          value: ovh
      - equal:
          path: spec.acme.solvers[0].dns01.webhook.config.endpoint
          value: ovh-eu
      - equal:
          path: spec.acme.solvers[0].dns01.webhook.config.authenticationMethod
          value: application
      - notExists:
          path: spec.acme.solvers[0].dns01.webhook.config.applicationKeyRef
        not: true
      - notExists:
          path: spec.acme.solvers[0].dns01.webhook.config.applicationSecretRef
        not: true
      - notExists:
          path: spec.acme.solvers[0].dns01.webhook.config.applicationConsumerKeyRef
        not: true
      - notExists:
          path: spec.acme.solvers[0].dns01.webhook.config.oauth2ClientIDRef
      - notExists:
          path: spec.acme.solvers[0].dns01.webhook.config.oauth2ClientSecretRef
      - equal:
          path: spec.acme.solvers[0].dns01.webhook.config.applicationKeyRef.name
          value: letsencrypt-prod-ovh-credentials
      - equal:
          path: spec.acme.solvers[0].dns01.webhook.config.applicationKeyRef.key
          value: applicationKey
      - equal:
          path: spec.acme.solvers[0].dns01.webhook.config.applicationSecretRef.name
          value: letsencrypt-prod-ovh-credentials
      - equal:
          path: spec.acme.solvers[0].dns01.webhook.config.applicationSecretRef.key
          value: applicationSecret
      - equal:
          path: spec.acme.solvers[0].dns01.webhook.config.applicationConsumerKeyRef.name
          value: letsencrypt-prod-ovh-credentials
      - equal:
          path: spec.acme.solvers[0].dns01.webhook.config.applicationConsumerKeyRef.key
          value: applicationConsumerKey

  - it: Validate use of `issuers` option in `ClusterIssuer` 3/5
    documentSelector:
      path: $[?(@.kind == "ClusterIssuer")].metadata.name
      value: le-staging-oidc-dir
    asserts:
      - equal:
          path: kind
          value: ClusterIssuer
      - equal:
          path: metadata.name
          value: le-staging-oidc-dir
      - equal:
          path: metadata.namespace
          value: default
        not: true
      - equal:
          path: spec.acme.server
          value: https://acme-staging-v02.api.letsencrypt.org/directory
      - equal:
          path: spec.acme.email
          value: tls-manager@example.net
      - exists:
          path: spec.acme.disableAccountKeyGeneration
      - notExists:
          path: spec.acme.externalAccountBinding
        not: true
      - equal:
          path: spec.acme.externalAccountBinding.keyID
          value: my-keyid-1
      - notExists:
          path: spec.acme.externalAccountBinding.keySecretRef.name
        not: true
      - equal:
          path: spec.acme.externalAccountBinding.keySecretRef.name
          value: eab-key-secret
      - equal:
          path: spec.acme.externalAccountBinding.keySecretRef.key
          value: eabKey
      - equal:
          path: spec.acme.profile
          value: classic
      - lengthEqual:
          path: spec.acme.solvers
          count: 1
      - equal:
          path: spec.acme.solvers[0].dns01.cnameStrategy
          value: Follow
      - equal:
          path: spec.acme.solvers[0].dns01.webhook.solverName
          value: ovh
      - equal:
          path: spec.acme.solvers[0].dns01.webhook.config.endpoint
          value: ovh-eu
      - equal:
          path: spec.acme.solvers[0].dns01.webhook.config.authenticationMethod
          value: oauth2
      - notExists:
          path: spec.acme.solvers[0].dns01.webhook.config.applicationKeyRef
      - notExists:
          path: spec.acme.solvers[0].dns01.webhook.config.applicationSecretRef
      - notExists:
          path: spec.acme.solvers[0].dns01.webhook.config.applicationConsumerKeyRef
      - notExists:
          path: spec.acme.solvers[0].dns01.webhook.config.oauth2ClientIDRef
        not: true
      - notExists:
          path: spec.acme.solvers[0].dns01.webhook.config.oauth2ClientSecretRef
        not: true
      - equal:
          path: spec.acme.solvers[0].dns01.webhook.config.oauth2ClientIDRef.name
          value: le-staging-oidc-dir-ovh-credentials
      - equal:
          path: spec.acme.solvers[0].dns01.webhook.config.oauth2ClientIDRef.key
          value: oauth2ClientID
      - equal:
          path: spec.acme.solvers[0].dns01.webhook.config.oauth2ClientSecretRef.name
          value: le-staging-oidc-dir-ovh-credentials
      - equal:
          path: spec.acme.solvers[0].dns01.webhook.config.oauth2ClientSecretRef.key
          value: oauth2ClientSecret

  - it: Validate use of `issuers` option in `ClusterIssuer` 4/5
    documentSelector:
      path: $[?(@.kind == "ClusterIssuer")].metadata.name
      value: le-staging-oidc-ref
    asserts:
      - equal:
          path: kind
          value: ClusterIssuer
      - equal:
          path: metadata.name
          value: le-staging-oidc-ref
      - equal:
          path: metadata.namespace
          value: default
        not: true
      - equal:
          path: spec.acme.server
          value: https://acme-staging-v02.api.letsencrypt.org/directory
      - equal:
          path: spec.acme.email
          value: tls-manager@example.net
      - notExists:
          path: spec.acme.disableAccountKeyGeneration
      - notExists:
          path: spec.acme.externalAccountBinding
      - equal:
          path: spec.acme.profile
          value: classic
      - lengthEqual:
          path: spec.acme.solvers
          count: 1
      - equal:
          path: spec.acme.solvers[0].dns01.cnameStrategy
          value: None
      - equal:
          path: spec.acme.solvers[0].dns01.webhook.solverName
          value: ovh
      - equal:
          path: spec.acme.solvers[0].dns01.webhook.config.endpoint
          value: ovh-eu
      - equal:
          path: spec.acme.solvers[0].dns01.webhook.config.authenticationMethod
          value: oauth2
      - notExists:
          path: spec.acme.solvers[0].dns01.webhook.config.applicationKeyRef
      - notExists:
          path: spec.acme.solvers[0].dns01.webhook.config.applicationSecretRef
      - notExists:
          path: spec.acme.solvers[0].dns01.webhook.config.applicationConsumerKeyRef
      - notExists:
          path: spec.acme.solvers[0].dns01.webhook.config.oauth2ClientID
      - notExists:
          path: spec.acme.solvers[0].dns01.webhook.config.oauth2ClientSecret
      - exists:
          path: spec.acme.solvers[0].dns01.webhook.config.oauth2ClientIDRef
      - exists:
          path: spec.acme.solvers[0].dns01.webhook.config.oauth2ClientSecretRef
      - equal:
          path: spec.acme.solvers[0].dns01.webhook.config.oauth2ClientIDRef.name
          value: ovh-credentials
      - equal:
          path: spec.acme.solvers[0].dns01.webhook.config.oauth2ClientIDRef.key
          value: oauth2ClientID
      - equal:
          path: spec.acme.solvers[0].dns01.webhook.config.oauth2ClientSecretRef.name
          value: ovh-credentials
      - equal:
          path: spec.acme.solvers[0].dns01.webhook.config.oauth2ClientSecretRef.key
          value: oauth2ClientSecret

  - it: Validate use of `issuers` option in `ClusterIssuer` 4/5
    documentSelector:
      path: $[?(@.kind == "ClusterIssuer")].metadata.name
      value: le-staging-app-ref
    asserts:
      - equal:
          path: kind
          value: ClusterIssuer
      - equal:
          path: metadata.name
          value: le-staging-app-ref
      - equal:
          path: metadata.namespace
          value: default
        not: true
      - equal:
          path: spec.acme.server
          value: https://acme-staging-v02.api.letsencrypt.org/directory
      - equal:
          path: spec.acme.email
          value: tls-manager@example.net
      - notExists:
          path: spec.acme.disableAccountKeyGeneration
      - notExists:
          path: spec.acme.externalAccountBinding
      - equal:
          path: spec.acme.profile
          value: classic
      - lengthEqual:
          path: spec.acme.solvers
          count: 1
      - equal:
          path: spec.acme.solvers[0].dns01.cnameStrategy
          value: None
      - equal:
          path: spec.acme.solvers[0].dns01.webhook.solverName
          value: ovh
      - equal:
          path: spec.acme.solvers[0].dns01.webhook.config.endpoint
          value: ovh-eu
      - equal:
          path: spec.acme.solvers[0].dns01.webhook.config.authenticationMethod
          value: application
      - exists:
          path: spec.acme.solvers[0].dns01.webhook.config.applicationKeyRef
      - exists:
          path: spec.acme.solvers[0].dns01.webhook.config.applicationSecretRef
      - exists:
          path: spec.acme.solvers[0].dns01.webhook.config.applicationConsumerKeyRef
      - equal:
          path: spec.acme.solvers[0].dns01.webhook.config.applicationKeyRef.name
          value: ovh-credentials
      - equal:
          path: spec.acme.solvers[0].dns01.webhook.config.applicationKeyRef.key
          value: applicationKey
      - equal:
          path: spec.acme.solvers[0].dns01.webhook.config.applicationSecretRef.name
          value: ovh-credentials
      - equal:
          path: spec.acme.solvers[0].dns01.webhook.config.applicationSecretRef.key
          value: applicationSecret
      - equal:
          path: spec.acme.solvers[0].dns01.webhook.config.applicationConsumerKeyRef.name
          value: ovh-credentials
      - equal:
          path: spec.acme.solvers[0].dns01.webhook.config.applicationConsumerKeyRef.key
          value: applicationConsumerKey
      - notExists:
          path: spec.acme.solvers[0].dns01.webhook.config.oauth2ClientID
      - notExists:
          path: spec.acme.solvers[0].dns01.webhook.config.oauth2ClientSecret
      - notExists:
          path: spec.acme.solvers[0].dns01.webhook.config.oauth2ClientIDRef
      - notExists:
          path: spec.acme.solvers[0].dns01.webhook.config.oauth2ClientSecretRef
---
suite: Testing `root.issuers` option in `secret.yaml` 2/2
templates:
  - secret.yaml
values:
  - values/valid/values.yaml
chart:
  version: 1.0.0
  appVersion: 1.0.0
tests:
  - it: Validate use of `issuers` option in `ClusterIssuer` 1/x
    documentSelector:
      path: $[?(@.kind == "Secret")].metadata.name
      value: letsencrypt-prod-ovh-credentials
    asserts:
      - equal:
          path: kind
          value: Secret
      - equal:
          path: metadata.name
          value: letsencrypt-prod-ovh-credentials
      - equal:
          path: metadata.namespace
          value: NAMESPACE
      - equal:
          path: data.applicationKey
          value: YXBwa2V5LTAxMjM0NTY3ODlhYmNkZWY=
      - equal:
          path: data.applicationSecret
          value: YXBwc2VjcmV0LTAxMjM0NTY3ODlhYmNkZWY=
      - equal:
          path: data.applicationConsumerKey
          value: YXBwY29uc3VtZXJrZXktMDEyMzQ1Njc4OWFiY2RlZg==

  - it: Validate use of `issuers` option in `ClusterIssuer` 2/x
    documentSelector:
      path: $[?(@.kind == "Secret")].metadata.name
      value: le-staging-oidc-dir-ovh-credentials
    asserts:
      - equal:
          path: kind
          value: Secret
      - equal:
          path: metadata.name
          value: le-staging-oidc-dir-ovh-credentials
      - equal:
          path: metadata.namespace
          value: NAMESPACE
      - equal:
          path: data.oauth2ClientID
          value: b2NsaWVudGlkLTAxMjM0NTY3ODlhYmNkZWY=
      - equal:
          path: data.oauth2ClientSecret
          value: b2NsaWVudHNlY3JldC0wMTIzNDU2Nzg5YWJjZGVm
